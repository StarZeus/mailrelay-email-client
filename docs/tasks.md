# Project Tasks: Email Processing System

## 1. Database Setup
- [x] Create database schema for all required tables
- [x] Set up PostgreSQL database
- [x] Create migration scripts
- [x] Create seed data for testing
- [x] Implement database connection pool
- [x] Add indexes for performance optimization

## 2. SMTP Server Implementation
- [x] Basic SMTP server setup with smtp-server package
- [x] Implement email parsing with mailparser
- [x] Implement attachment handling
  - [x] Store attachments in database with proper encoding
  - [x] Handle large attachments efficiently
  - [x] Add attachment size limits and validation
- [x] Email Processing Pipeline
  - [x] Parse incoming emails
  - [x] Extract metadata (subject, from, to, date)
  - [x] Store in database
  - [ ] Trigger rule processing
- [ ] Rule Processing Engine
  - [X] Pattern matching implementation
    - [X] Email address patterns
    - [X] Subject patterns
  - [X] Rule evaluation logic
    - [X] AND/OR operators
    - [X] Multiple rule matching
- [X] Action Execution System
  - [x] Forward email action
    - [x] SMTP client setup
    - [x] Template processing
    - [x] Error handling
  - [x] Webhook action
    - [x] HTTP client setup
    - [x] Retry logic
    - [x] Error handling
  - [x] Kafka action
    - [x] Kafka producer setup
    - [x] Message formatting
    - [x] Error handling
  - [x] JavaScript action
    - [x] Sandbox setup
    - [x] Security restrictions
    - [x] Error handling
  - [ ] Email Relay action
    - [x] Accept MJML emails template
    - [x] Parse incoming email and extract data as JSON
    - [x] Make all values in JSON data available as drag and drop data
    - [x] Render MJML template in split screen
    - [x] Pass data to MJML template
    - [x] Return composed email as string
    - [ ] Send composed email to recipient
    - [ ] Implment ability to extract email recipient from email body
    - [ ] Use data from email body to send email to multiple recipients
    - [x] Add popout window for MJML/HTML editor
    - [x] Implement draggable JSON tree view for email data
    - [x] Real-time preview of rendered template
  - [x] Common Features
    - [x] Config validation
    - [x] Retry mechanism
    - [x] Error logging

## 3. Web UI Implementation
### 3.1 Inbox Page
- [x] Email list view
  - [x] Pagination/infinite scroll
  - [x] Search functionality
  - [x] Sort by date
  - [x] Read/unread status
- [x] Email detail view
  - [x] Email metadata display
  - [x] Email body rendering
  - [x] Attachment handling
- [x] UI Components
  - [x] Email list item
  - [x] Email detail panel
  - [x] Loading states
  - [x] Error states
  - [x] Icon Button to refresh email list
  - [x] Icon Button to delete one or multiple emails
  - [x] Icon Button add filter and action based on selected emails 
  - [x] Toggle icon button to show all emails or only un processed emails
  - [x] Ability to show all emails or only un processed emails
  - [x] Ability to refresh email list
  - [x] Ability to delete one or multiple emails
  - [x] Ability to select one or multiple emails
  - [x] Ability to add filter and action based on selected emails
  - [x] Redirect user to filter page with the selected email id as query parameter
### 3.2 Processed Emails Page
- [x] Processed email list
  - [x] Group by rules
  - [x] Filter by status
  - [x] Search functionality
- [x] Processing details
  - [x] Rule matching info
  - [x] Action execution status
  - [x] Error details
- [x] UI Components
  - [x] Status indicators
  - [x] Rule grouping
    - [x] Group by rule name
    - [x] Collapse/expand rule groups with chevron icon
  - [x] Timeline view
  - [x] Icon Button to refresh email list
  - [x] Icon Button to delete one or multiple emails
  - [x] Ability to delete all processed emails
  - [x] Ability to refresh processed emails
  - [x] Confirmation dialog to delete processed emails

### 3.3 Filter Rules Page
- [x] Rule Management
  - [x] Create new rules
  - [x] Edit existing rules
  - [x] Delete rules
  - [x] Enable/disable rules
  - [x] When query parameter email id is present, fetch email details from database and prefill rule and actions form with selected emails data for a new rule
  - [x] Add new action based on selected emails and prefill rule and actions form with selected emails data
- [x] Action Configuration
  - [x] Forward email setup
  - [x] Webhook configuration
  - [x] Kafka settings
  - [x] JavaScript editor
      - [ ] Show list of available variables such as from, to, subject, body, body parsed as json object as drag and drop data
      - [ ] Drag and drop data is parsed as json object and made available to javascript
      - [ ] Javascript editor capable to receive drag and drop data from top portion
  - [x] Email relay action
    - [x] MJML template
    - [x] HTML template
    - [ ] Right drawer component wtih two column layout
    - [ ] Preview of the email that will be sent on the right column
    - [ ] Drag and drop data is parsed as json object and made available to mjml and html template on the left column top portion
    - [ ] Bottom portion of the left column template editor that allows drag and drop json data from top portion
- [x] UI Components
  - [x] Rule form
  - [x] Pattern input
  - [x] Action type selector
  - [x] Configuration forms

## 4. API Implementation
- [x] Email API
  - [x] List emails
  - [x] Get email details
  - [x] Update read status
  - [x] Search emails
- [x] Filter Rules API
  - [x] CRUD operations
  - [x] Rule validation
  - [x] Action configuration
- [x] Processed Emails API
  - [x] List processed emails
  - [x] Get processing details
  - [x] Filter by rule/status

## 5. Testing
- [x] Unit Tests
  - [x] Rule processing tests
    - [x] Pattern matching
    - [x] Rule evaluation
    - [x] Multiple rule handling
  - [x] Action execution tests
    - [x] Config validation
    - [x] Action execution
    - [x] Retry mechanism
    - [x] Error handling
  - [x] SMTP server tests
    - [x] Email parsing
    - [x] Attachment handling
    - [x] Rule processing triggers
    - [x] Error handling
  - [x] API endpoint tests
    - [x] Emails API
    - [x] Filter Rules API
    - [x] Processed Emails API
- [ ] Integration Tests
  - [x] Email processing flow
    - [x] Complete pipeline testing
    - [x] Multiple rule matching
    - [x] Error handling
  - [x] Rule matching
    - [x] Complex patterns
    - [x] OR/AND operators
    - [x] Disabled rules
    - [x] Regex patterns
  - [x] Action execution
    - [x] Forward action
    - [x] Webhook with retries
    - [x] Kafka integration
    - [x] JavaScript sandbox
    - [x] Error handling
- [ ] E2E Tests
  - [x] Web UI flows
    - [x] Inbox page functionality
    - [x] Processed emails page
    - [x] Filter rules management
    - [x] Error handling
    - [x] Loading states
  - [x] SMTP server
    - [x] Basic email receiving
    - [x] Attachment handling
    - [x] Rule matching
    - [x] Action execution
    - [x] Error handling
    - [x] Size limits
  - [x] Complete email processing
    - [x] End-to-end flow verification
    - [x] Error handling and UI feedback
    - [x] Real-time updates

## 6. Deployment
- [x] Docker Setup
  - [x] Dockerfile
  - [x] Docker Compose
  - [x] Environment configuration
- [ ] CI/CD Pipeline
  - [x] GitHub Actions
  - [ ] Automated testing
  - [ ] Deployment automation

## 7. Documentation
- [x] API Documentation
- [x] Setup Instructions
- [x] Configuration Guide
- [ ] User Guide
  - [ ] SMTP server usage
  - [ ] Web UI features
  - [ ] Rule configuration
  - [ ] Troubleshooting
